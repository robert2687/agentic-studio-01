
"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { Bot, Code, Play, Terminal, LayoutTemplate, GitBranch, Share2, Upload, Download, ArrowUp, Send, Bell, Settings, Save } from 'lucide-react';
import { Panel, PanelGroup, PanelResizeHandle } from 'react-resizable-panels';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { AgentStatus, type Agent } from '@/components/agentic-studio/agent-status';
import { FileTree, type FileNode } from '@/components/agentic-studio/file-tree';
import { ChatView, type Message } from '@/components/agentic-studio/chat-view';
import { CodeEditorView } from '@/components/agentic-studio/code-editor';
import { CanvasView } from '@/components/agentic-studio/canvas-view';
import { SandpackPreview } from '@/components/agentic-studio/sandpack-preview';
import { LogsView, type Log } from '@/components/agentic-studio/logs-view';
import { useToast } from "@/hooks/use-toast";
import { useAutoSave } from '@/hooks/use-auto-save';
import { SettingsDialog } from '@/components/agentic-studio/settings-dialog';

const initialFileStructure: FileNode = {
  name: 'my-app',
  type: 'folder',
  children: [
    {
      name: 'src',
      type: 'folder',
      children: [
        { name: 'App.jsx', type: 'file' },
        { name: 'index.css', type: 'file' },
      ],
    },
    { name: 'package.json', type: 'file' },
  ],
};

const initialAgents: Agent[] = [
  { id: 1, name: 'Requirements Analyst', status: 'Idle', progress: 0 },
  { id: 2, name: 'UI/UX Architect', status: 'Idle', progress: 0 },
  { id: 3, name: 'Frontend Coder', status: 'Idle', progress: 0 },
  { id: 4, name: 'Backend Coder', status: 'Idle', progress: 0 },
  { id: 5, name: 'QA & Security Agent', status: 'Idle', progress: 0 },
  { id: 6, name: 'DevOps & Deployment', status: 'Idle', progress: 0 },
];

const initialCode = `
import React, { useState } from 'react';

// Generated by Frontend Coder Agent
// Task: Create a login form

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    console.log('Logging in with:', { email, password });
  };

  return (
    <div className="flex items-center justify-center h-screen bg-gray-100">
      <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
        <h2 className="text-2xl font-bold text-center text-gray-900">Login</h2>
        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label htmlFor="email" className="text-sm font-medium text-gray-700">Email</label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900"
              required
            />
          </div>
          <div>
            <label htmlFor="password" className="text-sm font-medium text-gray-700">Password</label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900"
              required
            />
          </div>
          <button type="submit" className="w-full py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
            Log In
          </button>
        </form>
      </div>
    </div>
  );
}
  `;

const EDITOR_STORAGE_KEY = 'synapse-editor-code';

export default function AgenticStudioPage() {
  const [fileStructure, setFileStructure] = useState<FileNode>(initialFileStructure);
  const [agents, setAgents] = useState<Agent[]>(initialAgents);
  const [centerView, setCenterView] = useState('chat');
  const [rightView, setRightView] = useState('preview');
  const [messages, setMessages] = useState<Message[]>([
    { sender: 'ai', text: 'Welcome to **Synapse IDE**! I am your AI project manager. Tell me what you would like to build.' }
  ]);
  const [logs, setLogs] = useState<Log[]>([]);
  const [activeCodeFile, setActiveCodeFile] = useState('src/App.jsx');
  
  const [code, setCode] = useState(initialCode);
  const { isSaving } = useAutoSave(code, EDITOR_STORAGE_KEY);

  const [codeFiles, setCodeFiles] = useState<{ [key: string]: string }>({
    'src/App.jsx': initialCode,
    'src/index.css': '/* CSS content */',
    'package.json': '{ "name": "my-app" }',
  });
  
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);

  const { toast } = useToast();

  useEffect(() => {
    try {
      const savedCode = localStorage.getItem(EDITOR_STORAGE_KEY);
      if (savedCode) {
        setCode(JSON.parse(savedCode));
      }
    } catch (error) {
      console.error("Failed to load from localStorage", error);
    }
  }, []);

  const runAgentWorkflow = useCallback(() => {
    const newAgents = [...initialAgents];
    setMessages(prev => [...prev, { sender: 'ai', text: 'Okay, I will create a login page. I am engaging my team of AI agents to fulfill your request. You can see their status on the left.' }]);
    setLogs(prev => [...prev, { timestamp: new Date().toLocaleTimeString(), agent: "Orchestrator", message: "User request received: 'create a login page'. Engaging agent team." }]);

    const agentRunner = (agentName: string, duration: number, nextAgent: () => void) => {
        setAgents(prev => prev.map(a => a.name === agentName ? { ...a, status: 'Working', progress: 0 } : a));
        setLogs(prev => [...prev, { timestamp: new Date().toLocaleTimeString(), agent: agentName, message: "Task started." }]);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            if (progress <= 100) {
                setAgents(prev => prev.map(a => a.name === agentName ? { ...a, progress } : a));
            }
        }, duration / 10);
        
        setTimeout(() => {
            clearInterval(interval);
            setAgents(prev => prev.map(a => a.name === agentName ? { ...a, status: 'Done', progress: 100 } : a));
            setLogs(prev => [...prev, { timestamp: new Date().toLocaleTimeString(), agent: agentName, message: "Task completed successfully." }]);
            nextAgent();
        }, duration);
    };

    agentRunner("Requirements Analyst", 2000, () => {
        setMessages(prev => [...prev, { sender: 'ai', text: 'The **Requirements Analyst** has defined the components and functionality needed.' }]);
        agentRunner("UI/UX Architect", 3000, () => {
            setMessages(prev => [...prev, { sender: 'ai', text: 'The **UI/UX Architect** has designed the user interface and experience for the login page.' }]);
            agentRunner("Frontend Coder", 5000, () => {
                setFileStructure(prev => {
                    const newStructure = JSON.parse(JSON.stringify(prev));
                    const srcFolder = newStructure.children.find(c => c.name === 'src');
                    if (srcFolder) {
                        if (!srcFolder.children.find(c => c.name === 'LoginPage.jsx')) {
                            srcFolder.children.push({ name: 'LoginPage.jsx', type: 'file' });
                        }
                    }
                    return newStructure;
                });
                const newCode = initialCode;
                setCodeFiles(prev => ({...prev, 'src/LoginPage.jsx': newCode}));
                setCode(newCode);
                setActiveCodeFile('src/LoginPage.jsx');

                setMessages(prev => [...prev, { sender: 'ai', text: 'The **Frontend Coder** has implemented the React component for the login page. You can view it in the editor.' }]);
                agentRunner("QA & Security Agent", 4000, () => {
                    setMessages(prev => [...prev, { sender: 'ai', text: 'The **QA & Security Agent** has reviewed the code for issues and vulnerabilities.' }]);
                    agentRunner("DevOps & Deployment", 3000, () => {
                        setMessages(prev => [...prev, { sender: 'ai', text: 'All agents have completed their tasks. The login page is ready and can be seen in the live preview.' }]);
                        setLogs(prev => [...prev, { timestamp: new Date().toLocaleTimeString(), agent: "Orchestrator", message: "Workflow complete. All agents finished." }]);
                    });
                });
            });
        });
    });
  }, []);

  const handleSendMessage = useCallback((text: string) => {
    setMessages(prev => [...prev, { sender: 'user', text }]);
    if (text.toLowerCase().includes('create a login page')) {
      runAgentWorkflow();
    } else {
        setTimeout(() => {
            setMessages(prev => [...prev, { sender: 'ai', text: 'I can help with that. What are the specific requirements?' }]);
        }, 1000);
    }
  }, [runAgentWorkflow]);

  const handleCodeChange = useCallback((newCode: string) => {
    setCode(newCode);
    setCodeFiles(prev => ({
        ...prev,
        [activeCodeFile]: newCode
    }))
  }, [activeCodeFile]);

  return (
    <div className="bg-background text-foreground h-screen flex flex-col font-sans">
      <header className="flex items-center justify-between h-14 px-4 border-b border-border flex-shrink-0 bg-card">
        <div className="flex items-center space-x-4">
          <Bot size={24} className="text-primary" />
          <h1 className="text-lg font-grotesk font-bold">Synapse IDE</h1>
          <div className="flex items-center bg-muted px-3 py-1 rounded-md text-sm">
            <GitBranch size={14} className="mr-2" />
            <span>main</span>
          </div>
          <Button variant="outline" size="sm" onClick={() => toast({ title: "Committing...", description: "Staging changes and committing to the local branch." })}>
            Commit
          </Button>
          <div className="flex items-center space-x-1">
            <Button variant="outline" size="sm" onClick={() => toast({ title: "Pushing...", description: "Pushing changes to the remote repository." })}>
              <ArrowUp size={14} className="mr-2" />
              Push
            </Button>
            <Button variant="outline" size="sm" onClick={() => toast({ title: "Pulling...", description: "Fetching and merging changes from the remote." })}>
              <Download size={14} className="mr-2" />
              Pull
            </Button>
          </div>
        </div>
        <div className="flex items-center space-x-2">
            {isSaving && <div className="flex items-center text-sm text-muted-foreground"><Save size={14} className="mr-1 animate-pulse" /> Saving...</div>}
          <Button variant="default" size="sm" onClick={() => toast({ title: "Shared", description: "Project shared successfully." })}>
            <Share2 size={14} className="mr-2" />
            Share
          </Button>
          <Button variant="ghost" size="icon" className="text-muted-foreground hover:text-foreground" onClick={() => toast({ title: "Notifications", description: "No new notifications." })}>
            <Bell size={20} />
          </Button>
          <Button variant="ghost" size="icon" className="text-muted-foreground hover:text-foreground" onClick={() => setIsSettingsOpen(true)}>
            <Settings size={20} />
          </Button>
          <Avatar>
            <AvatarFallback className="bg-primary text-primary-foreground font-bold text-sm">U</AvatarFallback>
          </Avatar>
        </div>
      </header>

      <main className="flex flex-1 overflow-hidden">
        <PanelGroup direction="horizontal">
          {/* Left Panel: Navigation & Agent Overview */}
          <Panel defaultSize={20} minSize={15} className="min-w-[280px] bg-card border-r border-border flex flex-col">
            <div className="p-4 border-b border-border">
              <h2 className="text-md font-grotesk font-semibold">Explorer</h2>
            </div>
            <div className="flex-1 overflow-y-auto py-2">
              <FileTree node={fileStructure} />
            </div>
            <div className="border-t border-border flex-shrink-0">
              <AgentStatus agents={agents} />
            </div>
          </Panel>
          
          <PanelResizeHandle className="w-1 bg-border/50 hover:bg-primary/50 transition-colors" />

          {/* Center Panel: Dynamic Workspace */}
          <Panel defaultSize={40} minSize={30} className="flex flex-col border-r border-border">
            <div className="flex-shrink-0 border-b border-border bg-card">
              <div className="flex space-x-1 p-2">
                <Button variant={centerView === 'chat' ? 'secondary' : 'ghost'} size="sm" onClick={() => setCenterView('chat')}>
                  <Bot size={16} className="mr-2" /> Chat
                </Button>
                <Button variant={centerView === 'code' ? 'secondary' : 'ghost'} size="sm" onClick={() => setCenterView('code')}>
                  <Code size={16} className="mr-2" /> Code
                </Button>
                <Button variant={centerView === 'canvas' ? 'secondary' : 'ghost'} size="sm" onClick={() => setCenterView('canvas')}>
                  <LayoutTemplate size={16} className="mr-2" /> Canvas
                </Button>
              </div>
            </div>
            <div className="flex-1 overflow-hidden bg-background">
              {centerView === 'chat' && <ChatView messages={messages} onSendMessage={handleSendMessage} />}
              {centerView === 'code' && <CodeEditorView content={code} onContentChange={handleCodeChange} />}
              {centerView === 'canvas' && <CanvasView />}
            </div>
          </Panel>

          <PanelResizeHandle className="w-1 bg-border/50 hover:bg-primary/50 transition-colors" />

          {/* Right Panel: Immediate Feedback */}
          <Panel defaultSize={40} minSize={30} className="flex flex-col bg-muted/30">
            <div className="flex-shrink-0 border-b border-border bg-card">
              <div className="flex space-x-1 p-2">
                <Button variant={rightView === 'preview' ? 'secondary' : 'ghost'} size="sm" onClick={() => setRightView('preview')}>
                   <Play size={16} className="mr-2" /> Live Preview
                </Button>
                <Button variant={rightView === 'logs' ? 'secondary' : 'ghost'} size="sm" onClick={() => setRightView('logs')}>
                  <Terminal size={16} className="mr-2" /> Logs
                </Button>
              </div>
            </div>
            <div className="flex-1 overflow-hidden p-4">
              {rightView === 'preview' && <SandpackPreview code={code} />}
              {rightView === 'logs' && <LogsView logs={logs} />}
            </div>
          </Panel>
        </PanelGroup>
      </main>
      <SettingsDialog open={isSettingsOpen} onOpenChange={setIsSettingsOpen} />
    </div>
  );
}
